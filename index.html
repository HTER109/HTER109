<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Monitor de Alarmas ESP32</title>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
}

.tabs {
  display: flex;
  cursor: pointer;
  margin-bottom: 10px;
}

.tab {
  padding: 10px 20px;
  border: 1px solid #ccc;
  border-bottom: none;
  background-color: #f1f1f1;
}

.tab.active {
  background-color: white;
  font-weight: bold;
}

.tab.alarm-active-tab {
  background-color: red !important;
  color: white;
}

.tab-content {
  display: none;
  border: 1px solid #ccc;
  padding: 10px;
}

.tab-content.active {
  display: block;
}

/* ðŸ”¹ CONTENEDOR PRINCIPAL */
.main-container {
  display: flex;
  gap: 20px;
}

/* ðŸ”¹ ALARMAS A MEDIA PANTALLA */
.alarms-container {
  width: 50%;
}

.alarm {
  border: 1px solid #ccc;
  border-radius: 5px;
  padding: 6px;
  margin: 4px 0;
  font-size: 12px;
}

.active {
  background-color: #ffe5e5;
  color: #b30000;
  font-weight: bold;
}

.inactive {
  background-color: #e5ffe5;
  color: #007000;
}

/* ðŸ”¹ HISTORIAL */
.history-container {
  width: 50%;
}

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 12px;
}

th, td {
  border: 1px solid #ccc;
  padding: 4px;
  text-align: center;
}

th {
  background-color: #f1f1f1;
}

button {
  margin: 5px 0;
  padding: 6px 12px;
  cursor: pointer;
}
</style>
</head>

<body>

<h2>Estado de Alarmas ESP32 (EMQX)</h2>

<div class="tabs">
  <div class="tab active" onclick="showTab(0)">EstaciÃ³n OTY</div>
  <div class="tab" onclick="showTab(1)">EstaciÃ³n ITR</div>
</div>

<!-- ================= OTY ================= -->
<div id="tab-0" class="tab-content active">
  <div class="main-container">
    <div class="alarms-container">
      <div id="alarms-external-ITR"></div>
    </div>

    <div class="history-container">
      <h3>Historial de Alarmas</h3>
      <button onclick="downloadCSV()">Descargar Excel</button>
      <table>
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Hora</th>
            <th>EstaciÃ³n</th>
            <th>Alarma</th>
          </tr>
        </thead>
        <tbody id="alarm-history"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ================= ITR ================= -->
<div id="tab-1" class="tab-content">
  <div class="main-container">
    <div class="alarms-container">
      <div id="alarms-external-OTY"></div>
    </div>
  </div>
</div>

<script>
const client = mqtt.connect(
  'wss://d4e6f442.ala.us-east-1.emqxsl.com:8084/mqtt',
  {
    clientId: 'web_' + Math.random().toString(16).substr(2, 8),
    username: 'Olivas',
    password: 'Jangel27'
  }
);

const alarmNamesOTY = [
 "FALLA ALIM COM","GPO ELEC OPER","FALLA FUS DIST",
 "FALLA RECT","ALTA TEMP","FALLA FUS VOLTA",
 "BAT EN OPER","BAJO VOLTAJE",
 "LIBRE 1","LIBRE 2","LIBRE 3","LIBRE 4",
 "LIBRE 5","LIBRE 6","LIBRE 7","LIBRE 8"
];

let alarmHistory = [];
let lastStateOTY = 0;

window.onload = () => {
  const saved = localStorage.getItem('alarmHistory2026');
  if (saved) {
    alarmHistory = JSON.parse(saved);
    alarmHistory.forEach(addRowToTable);
  }
};

client.on('connect', () => {
  client.subscribe('esp32/External_Alarms_2');
});

client.on('message', (topic, message) => {
  const value = (message[0] << 8) | message[1];
  updateAlarms(value);
});

function updateAlarms(value) {
  const container = document.getElementById('alarms-external-OTY');
  container.innerHTML = '';

  let hasActive = false;

  for (let i = 15; i >= 0; i--) {
    const bit = (value >> i) & 1;
    const prev = (lastStateOTY >> i) & 1;

    if (bit && !prev) {
      logAlarm("OTY", alarmNamesOTY[15 - i]);
    }

    if (bit) hasActive = true;

    const div = document.createElement('div');
    div.className = 'alarm ' + (bit ? 'active' : 'inactive');
    div.textContent = alarmNamesOTY[15 - i] + (bit ? ' ðŸ”¥' : ' âœ…');
    container.appendChild(div);
  }

  toggleAlarmTab(0, hasActive);
  lastStateOTY = value;
}

function logAlarm(station, alarm) {
  const now = new Date();
  const entry = {
    date: now.toLocaleDateString('es-MX'),
    time: now.toLocaleTimeString('es-MX'),
    station,
    alarm
  };

  alarmHistory.push(entry);
  localStorage.setItem('alarmHistory2026', JSON.stringify(alarmHistory));
  addRowToTable(entry);
}

function addRowToTable(e) {
  const row = document.createElement('tr');
  row.innerHTML = `<td>${e.date}</td><td>${e.time}</td><td>${e.station}</td><td>${e.alarm}</td>`;
  document.getElementById('alarm-history').appendChild(row);
}

function downloadCSV() {
  let csv = 'Fecha,Hora,EstaciÃ³n,Alarma\n';
  alarmHistory.forEach(e => {
    csv += `"${e.date}","${e.time}","${e.station}","${e.alarm}"\n`;
  });

  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'historial_alarmas_2026.csv';
  a.click();
  URL.revokeObjectURL(url);
}

function toggleAlarmTab(index, active) {
  const tabs = document.querySelectorAll('.tab');
  if (active) tabs[index].classList.add('alarm-active-tab');
  else tabs[index].classList.remove('alarm-active-tab');
}

function showTab(i) {
  document.querySelectorAll('.tab').forEach((t, idx) =>
    t.classList.toggle('active', idx === i)
  );
  document.querySelectorAll('.tab-content').forEach((c, idx) =>
    c.classList.toggle('active', idx === i)
  );
}
</script>

</body>
</html>

