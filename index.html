<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Monitor de Alarmas ESP32</title>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<style>
body { font-family: Arial, sans-serif; }

.tabs { display: flex; cursor: pointer; margin-bottom: 10px; }

.tab {
  padding: 10px 20px;
  border: 1px solid #ccc;
  border-bottom: none;
  background-color: #f1f1f1;
}

.tab.active { background-color: white; font-weight: bold; }

.tab.alarm-active-tab { background-color: red !important; color: white; }

.tab-content { display: none; border: 1px solid #ccc; padding: 10px; }

.tab-content.active { display: block; }

.main-container { display: flex; gap: 20px; }

.alarms-container { width: 50%; }

.alarm {
  border: 1px solid #ccc;
  border-radius: 5px;
  padding: 6px;
  margin: 4px 0;
  font-size: 12px;
}

.active { background-color: #ffe5e5; color: #b30000; font-weight: bold; }
.inactive { background-color: #e5ffe5; color: #007000; }

.history-container { width: 50%; }

table { width: 100%; border-collapse: collapse; font-size: 12px; }

th, td { border: 1px solid #ccc; padding: 4px; text-align: center; }

th { background-color: #f1f1f1; }

button, input[type="date"] { margin: 5px 4px; padding: 6px 10px; cursor: pointer; }

.alarm {
  stroke: green;
  fill: green;
  transition: all 0.3s ease;
}

.alarm.alarm-on {
  stroke: red;
  fill: red;
}

.alarm.warning {
  stroke: orange;
  fill: orange;
}

</style>
</head>

<body>

<h2>Estado de Alarmas ESP32 (EMQX)</h2>

<div class="tabs">
  <div class="tab active" onclick="showTab(0)">Historial OTY</div>
  <div class="tab" onclick="showTab(1)">Historial ITR</div>
  <div class="tab" onclick="showTab(2)">Alarmas OTYY</div>
  <div class="tab" onclick="showTab(3)">Alarmas ITR</div>
</div>

<!-- ================= HISTORIAL OTY (SIN CAMBIOS) ================= -->
<div id="tab-0" class="tab-content active">
  <div class="main-container">
    <div class="alarms-container">
      <div id="alarms-OTY"></div>
    </div>

    <div class="history-container">
      <h3>Historial OTY</h3>
      <input type="date" onchange="filterHistory('OTY', this.value)">
      <button onclick="showAllHistory('OTY')">Mostrar todo</button>
      <button onclick="clearHistory('OTY')">Limpiar historial</button>
      <button onclick="downloadCSV('OTY')">Descargar Excel</button>

      <table>
        <thead>
          <tr><th>Fecha</th><th>Hora</th><th>Estaci√≥n</th><th>Alarma</th></tr>
        </thead>
        <tbody id="alarm-history-OTY"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ================= HISTORIAL ITR (SIN CAMBIOS) ================= -->
<div id="tab-1" class="tab-content">
  <div class="main-container">
    <div class="alarms-container">
      <div id="alarms-ITR"></div>
    </div>

    <div class="history-container">
      <h3>Historial ITR</h3>
      <input type="date" onchange="filterHistory('ITR', this.value)">
      <button onclick="showAllHistory('ITR')">Mostrar todo</button>
      <button onclick="clearHistory('ITR')">Limpiar historial</button>
      <button onclick="downloadCSV('ITR')">Descargar Excel</button>

      <table>
        <thead>
          <tr><th>Fecha</th><th>Hora</th><th>Estaci√≥n</th><th>Alarma</th></tr>
        </thead>
        <tbody id="alarm-history-ITR"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ================= ALARMAS OTY (VAC√çA) ================= -->
<div id="tab-2" class="tab-content">
 <div id="tab-alarmas-oty" class="tab-content">

  <svg id="svg-oty" viewBox="0 0 600 400" width="100%" height="100%">

    <!-- Caseta -->
    <polygon points="300,40 60,160 540,160"
             fill="none" stroke="#000" stroke-width="3"/>

    <rect x="60" y="160" width="480" height="200"
          fill="none" stroke="#000" stroke-width="3"/>

    <!-- ===== ALARMA TEMPERATURA ===== -->
    <g id="oty-temp" class="alarm normal">
      <!-- Term√≥metro -->
      <line x1="300" y1="190" x2="300" y2="260"
            stroke-width="8" stroke-linecap="round"/>

      <circle cx="300" cy="280" r="16"/>
      <text x="300" y="320" text-anchor="middle"
            font-size="14">Temperatura</text>
    </g>

    <!-- ===== ALARMA TIERRA ===== -->
    <g id="oty-tierra" class="alarm normal">
      <!-- S√≠mbolo tierra -->
      <line x1="450" y1="210" x2="450" y2="260" stroke-width="4"/>
      <line x1="430" y1="260" x2="470" y2="260" stroke-width="4"/>
      <line x1="435" y1="270" x2="465" y2="270" stroke-width="3"/>
      <line x1="440" y1="280" x2="460" y2="280" stroke-width="2"/>

      <text x="450" y="320" text-anchor="middle"
            font-size="14">Tierra</text>
    </g>

  </svg>
</div>

</div>

<!-- ================= ALARMAS ITR (VAC√çA) ================= -->
<div id="tab-3" class="tab-content">
  <h3>Alarmas ITR</h3>
  <!-- Vac√≠o por ahora -->
</div>

<script>
const client = mqtt.connect(
  'wss://d4e6f442.ala.us-east-1.emqxsl.com:8084/mqtt',
  { clientId: 'web_' + Math.random().toString(16).substr(2,8),
    username: 'Olivas', password: 'Jangel27' }
);

const alarmNames = [
 "FALLA ALIM COM","GPO ELEC OPER","FALLA FUS DIST",
 "FALLA RECT","ALTA TEMP","FALLA FUS VOLTA",
 "BAT EN OPER","BAJO VOLTAJE",
 "LIBRE 1","LIBRE 2","LIBRE 3","LIBRE 4",
 "LIBRE 5","LIBRE 6","LIBRE 7","LIBRE 8"
];

let alarmHistoryOTY = [];
let alarmHistoryITR = [];
let visibleHistoryOTY = [];
let visibleHistoryITR = [];
let lastState = 0;

window.onload = () => {
  alarmHistoryOTY = JSON.parse(localStorage.getItem('alarmHistoryOTY_2026')) || [];
  alarmHistoryITR = JSON.parse(localStorage.getItem('alarmHistoryITR_2026')) || [];

  visibleHistoryOTY = [...alarmHistoryOTY];
  visibleHistoryITR = [...alarmHistoryITR];

  renderHistory('OTY', visibleHistoryOTY);
  renderHistory('ITR', visibleHistoryITR);
};

client.on('connect', () => client.subscribe('esp32/External_Alarms_2'));

client.on('message', (t, m) => {
  const value = (m[0] << 8) | m[1];
  updateStation('OTY', value);
  updateStation('ITR', value);
  lastState = value;
});

function updateStation(station, value) {
  const cont = document.getElementById(`alarms-${station}`);
  cont.innerHTML = '';
  let active = false;

  for (let i = 15; i >= 0; i--) {
    const bit = (value >> i) & 1;
    const prev = (lastState >> i) & 1;

    if (bit && !prev) logAlarm(station, alarmNames[15 - i]);
    if (bit) active = true;

    const d = document.createElement('div');
    d.className = 'alarm ' + (bit ? 'active' : 'inactive');
    d.textContent = alarmNames[15 - i] + (bit ? ' üî•' : ' ‚úÖ');
    cont.appendChild(d);
  }

  toggleAlarmTab(station === 'OTY' ? 0 : 1, active);
}

function logAlarm(st, al) {
  const now = new Date();
  const e = {
    date: now.toLocaleDateString('es-MX'),
    time: now.toLocaleTimeString('es-MX'),
    station: st,
    alarm: al
  };

  const ref = st === 'OTY' ? alarmHistoryOTY : alarmHistoryITR;
  ref.push(e);

  localStorage.setItem(`alarmHistory${st}_2026`, JSON.stringify(ref));
  showAllHistory(st);
}

function renderHistory(st, data) {
  const tb = document.getElementById(`alarm-history-${st}`);
  tb.innerHTML = '';
  data.forEach(e => {
    tb.innerHTML += `<tr>
      <td>${e.date}</td>
      <td>${e.time}</td>
      <td>${e.station}</td>
      <td>${e.alarm}</td>
    </tr>`;
  });

  if (st === 'OTY') visibleHistoryOTY = data;
  else visibleHistoryITR = data;
}

function filterHistory(st, d) {
  const src = st === 'OTY' ? alarmHistoryOTY : alarmHistoryITR;
  const filtered = src.filter(e =>
    new Date(e.date.split('/').reverse().join('-'))
      .toISOString().slice(0,10) === d
  );
  renderHistory(st, filtered);
}

function showAllHistory(st) {
  const src = st === 'OTY' ? alarmHistoryOTY : alarmHistoryITR;
  renderHistory(st, [...src]);
}

function clearHistory(st) {
  if (!confirm(`¬øBorrar historial de ${st}?`)) return;

  if (st === 'OTY') {
    alarmHistoryOTY = [];
    visibleHistoryOTY = [];
    localStorage.removeItem('alarmHistoryOTY_2026');
  } else {
    alarmHistoryITR = [];
    visibleHistoryITR = [];
    localStorage.removeItem('alarmHistoryITR_2026');
  }

  renderHistory(st, []);
}

function downloadCSV(st) {
  const src = st === 'OTY' ? visibleHistoryOTY : visibleHistoryITR;

  let csv = 'Fecha,Hora,Estaci√≥n,Alarma\n';
  src.forEach(e => {
    csv += `"${e.date}","${e.time}","${e.station}","${e.alarm}"\n`;
  });

  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);

  const a = document.createElement('a');
  a.href = url;
  a.download = `historial_${st}_2026.csv`;
  a.click();

  URL.revokeObjectURL(url);
}

function toggleAlarmTab(i, a) {
  document.querySelectorAll('.tab')[i]
    .classList.toggle('alarm-active-tab', a);
}

function showTab(i) {
  document.querySelectorAll('.tab').forEach((t, x) =>
    t.classList.toggle('active', x === i)
  );
  document.querySelectorAll('.tab-content').forEach((c, x) =>
    c.classList.toggle('active', x === i)
  );
}
</script>

<script>
  function activarAlarma(id) {
    const el = document.getElementById(id);
    if (!el) return;
    el.classList shows
    el.classList.remove("normal");
    el.classList.add("alarm-on");
  }

  function desactivarAlarma(id) {
    const el = document.getElementById(id);
    if (!el) return;
    el.classList.remove("alarm-on");
    el.classList.add("normal");
  }
</script>

<script>
  setTimeout(() => activarAlarma("oty-temp"), 2000);
  setTimeout(() => activarAlarma("oty-tierra"), 4000);
  setTimeout(() => desactivarAlarma("oty-temp"), 6000);
</script>


</body>
</html>

