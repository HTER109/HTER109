<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Monitor de Alarmas ESP32</title>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<style>
body { font-family: Arial, sans-serif; }

.tabs { display: flex; cursor: pointer; margin-bottom: 10px; }

.tab {
  padding: 10px 20px;
  border: 1px solid #ccc;
  border-bottom: none;
  background-color: #f1f1f1;
}

.tab.active { background-color: white; font-weight: bold; }
.tab.alarm-active-tab { background-color: red !important; color: white; }

.tab-content { display: none; border: 1px solid #ccc; padding: 10px; }
.tab-content.active { display: block; }

.main-container { display: flex; gap: 20px; }

.alarms-container { width: 50%; }

/* ===== ALARMAS HTML ===== */
.alarm {
  border: 1px solid #ccc;
  border-radius: 5px;
  padding: 6px;
  margin: 4px 0;
  font-size: 12px;
}

.active { background-color: #ffe5e5; color: #b30000; font-weight: bold; }
.inactive { background-color: #e5ffe5; color: #007000; }

/* ===== SVG ===== */

/* ===== SVG ===== */
.svg-alarm {
  stroke: #555;       /* l√≠neas visibles */
  fill: none;         /* SIN relleno en estado normal */
  transition: all 0.3s ease;
}

.svg-alarm.alarm-on {
  stroke: red;
  fill: red;          /* SOLO se rellena cuando hay alarma */
}

.svg-alarm * {
  stroke: inherit;
  fill: inherit;
}




.history-container { width: 50%; }

table { width: 100%; border-collapse: collapse; font-size: 12px; }

th, td { border: 1px solid #ccc; padding: 4px; text-align: center; }

th { background-color: #f1f1f1; }

button, input[type="date"] { margin: 5px 4px; padding: 6px 10px; cursor: pointer; }
</style>
</head>

<body>

<h2>Estado de Alarmas ESP32 (EMQX)</h2>

<div class="tabs">
  <div class="tab active" onclick="showTab(0)">Historial OTY</div>
  <div class="tab" onclick="showTab(1)">Historial ITR</div>
  <div class="tab" onclick="showTab(2)">Alarmas OTY</div>
  <div class="tab" onclick="showTab(3)">Alarmas ITR</div>
</div>

<!-- ================= HISTORIAL OTY ================= -->
<div id="tab-0" class="tab-content active">
  <div class="main-container">
    <div class="alarms-container">
      <div id="alarms-OTY"></div>
    </div>

    <div class="history-container">
      <h3>Historial OTY</h3>
      <input type="date" onchange="filterHistory('OTY', this.value)">
      <button onclick="showAllHistory('OTY')">Mostrar todo</button>
      <button onclick="clearHistory('OTY')">Limpiar historial</button>
      <button onclick="downloadCSV('OTY')">Descargar Excel</button>

      <table>
        <thead>
          <tr><th>Fecha</th><th>Hora</th><th>Estaci√≥n</th><th>Alarma</th></tr>
        </thead>
        <tbody id="alarm-history-OTY"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ================= HISTORIAL ITR ================= -->
<div id="tab-1" class="tab-content">
  <div class="main-container">
    <div class="alarms-container">
      <div id="alarms-ITR"></div>
    </div>

    <div class="history-container">
      <h3>Historial ITR</h3>
      <input type="date" onchange="filterHistory('ITR', this.value)">
      <button onclick="showAllHistory('ITR')">Mostrar todo</button>
      <button onclick="clearHistory('ITR')">Limpiar historial</button>
      <button onclick="downloadCSV('ITR')">Descargar Excel</button>

      <table>
        <thead>
          <tr><th>Fecha</th><th>Hora</th><th>Estaci√≥n</th><th>Alarma</th></tr>
        </thead>
        <tbody id="alarm-history-ITR"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ================= ALARMAS OTY ================= -->
<div id="tab-2" class="tab-content">

<svg viewBox="0 0 800 850" width="100%" height="850">


  <!-- ================= CASETA ================= -->
  <polygon points="400,40 90,190 710,190"
           fill="none" stroke="#000" stroke-width="3"/>
  <rect x="90" y="190" width="620" height="420"
        fill="none" stroke="#000" stroke-width="3"/>

  <!-- ================= TEMPERATURA (SUPERIOR CENTRO) ================= -->
  <g transform="translate(320,210)">
    <rect x="0" y="0" width="160" height="120"
          fill="none" stroke="#000" stroke-width="2"/>

    <text x="80" y="-10" text-anchor="middle"
          font-size="14" font-weight="bold">
      Temperatura
    </text>

    <g id="oty-temp" class="svg-alarm" transform="translate(80,35)">
      <line x1="0" y1="-15" x2="0" y2="20"
            stroke-width="8" stroke-linecap="round"/>
      <circle cx="0" cy="40" r="16"/>
    </g>
  </g>

  <!-- ================= TIERRA (ESQUINA SUPERIOR DERECHA) ================= -->
  <g transform="translate(520,210)">
    <rect x="0" y="0" width="150" height="120"
          fill="none" stroke="#000" stroke-width="2"/>

    <text x="75" y="-10" text-anchor="middle"
          font-size="14" font-weight="bold">
      Tierra
    </text>

    <g id="oty-tierra" class="svg-alarm" transform="translate(75,30)">
      <line x1="0" y1="0" x2="0" y2="40" stroke-width="4"/>
      <line x1="-20" y1="40" x2="20" y2="40" stroke-width="4"/>
      <line x1="-15" y1="50" x2="15" y2="50" stroke-width="3"/>
      <line x1="-10" y1="60" x2="10" y2="60" stroke-width="2"/>
    </g>
  </g>

  <!-- ================= HABITACI√ìN DE BATER√çAS (INFERIOR IZQUIERDA) ================= -->
  <g transform="translate(140,370)">
    <rect x="0" y="0" width="260" height="170"
          fill="none" stroke="#000" stroke-width="2"/>

    <text x="130" y="-10" text-anchor="middle"
          font-size="14" font-weight="bold">
      Habitaci√≥n de Bater√≠as
    </text>

    <g id="oty-person" class="svg-alarm" transform="translate(40,50)">
      <circle cx="15" cy="10" r="8"/>
      <line x1="15" y1="18" x2="15" y2="45"/>
      <line x1="0" y1="30" x2="30" y2="30"/>
      <line x1="15" y1="45" x2="5" y2="65"/>
      <line x1="15" y1="45" x2="25" y2="65"/>
    </g>

    <g id="oty-battery" class="svg-alarm" transform="translate(140,55)">
      <rect x="0" y="15" width="70" height="35" fill="none"/>
      <rect x="15" y="5" width="10" height="10"/>
      <rect x="45" y="5" width="10" height="10"/>
      <text x="10" y="40" font-size="14">+</text>
      <text x="55" y="40" font-size="14">‚àí</text>
    </g>
  </g>

  <!-- ================= PLANTA CD (INFERIOR DERECHA) ================= -->
  <g transform="translate(430,370)">
    <rect x="0" y="0" width="260" height="170"
          fill="none" stroke="#000" stroke-width="2"/>

    <text x="130" y="-10" text-anchor="middle"
          font-size="14" font-weight="bold">
      Planta CD
    </text>

    <!-- Rectificador -->
    <g id="oty-rectifier" class="svg-alarm" transform="translate(30,45)">
      <rect x="0" y="0" width="70" height="50" rx="4" fill="none"/>
      <line x1="10" y1="15" x2="60" y2="15"/>
      <line x1="10" y1="25" x2="60" y2="25"/>
      <line x1="10" y1="35" x2="60" y2="35"/>
      <text x="35" y="70" text-anchor="middle" font-size="12">
        Rectificador
      </text>
    </g>

    <!-- Breakers -->
    <g id="oty-breakers" class="svg-alarm" transform="translate(140,45)">
      <rect x="0" y="0" width="25" height="40" fill="none"/>
      <line x1="12" y1="10" x2="12" y2="30"/>
      <rect x="35" y="0" width="25" height="40" fill="none"/>
      <line x1="47" y1="10" x2="47" y2="30"/>
      <rect x="70" y="0" width="25" height="40" fill="none"/>
      <line x1="82" y1="10" x2="82" y2="30"/>
      <text x="47" y="70" text-anchor="middle" font-size="12">
        Breakers
      </text>
    </g>
      </g> <!-- FIN PLANTA CD -->


<!-- ===== FLECHA HACIA PLANTA CD (MAS GRUESA) ===== -->
<g id="arrow-to-cd" transform="translate(560,630)">
  <line x1="0" y1="0" x2="0" y2="45"
        stroke="#000" stroke-width="6"/>
  <polygon points="-12,45 0,60 12,45"
           fill="#000"/>
</g>

<!-- ===== ATS (AUTOMATIC TRANSFER SWITCH) ===== -->
<g id="oty-ats" class="svg-alarm" transform="translate(480,700)">

  <!-- Marco ATS -->
  <rect x="0" y="0" width="200" height="130"
        fill="none" stroke="#000" stroke-width="2"/>

  <!-- L√≠nea vertical (NORTE - ATS) -->
  <line x1="100" y1="15" x2="100" y2="65"
        stroke="#000" stroke-width="5"/>
  <text x="110" y="45" font-size="14" font-weight="bold">
    ATS
  </text>

  <!-- L√≠nea hacia OESTE (GEN) -->
  <line x1="100" y1="65" x2="25" y2="65"
        stroke="red" stroke-width="5"/>
  <text x="20" y="60" font-size="14" fill="red"
        text-anchor="end" font-weight="bold">
    GEN
  </text>

  <!-- L√≠nea hacia ESTE (CFE) -->
  <line x1="100" y1="65" x2="175" y2="65"
        stroke="green" stroke-width="5"/>
  <text x="180" y="60" font-size="14" fill="green"
        text-anchor="start" font-weight="bold">
    CFE
  </text>

  <!-- Texto inferior -->
  <text x="100" y="115" text-anchor="middle"
        font-size="14" font-weight="bold">
    ATS
  </text>

</g>


</svg>


</div>

<!-- ================= ALARMAS ITR ================= -->
<div id="tab-3" class="tab-content">
  <h3>Alarmas ITR</h3>
</div>

<!-- ===== TU SCRIPT ORIGINAL (SIN CAMBIOS) ===== -->
<script>

const BACKEND_URL = 'https://backend-alarms.onrender.com';



const alarmNames = [
 "FALLA ALIM COM","GPO ELEC OPER","FALLA FUS DIST",
 "FALLA RECT","ALTA TEMP","FALLA FUS VOLTA",
 "BAT EN OPER","BAJO VOLTAJE",
 "LIBRE 1","LIBRE 2","LIBRE 3","LIBRE 4",
 "LIBRE 5","LIBRE 6","LIBRE 7","LIBRE 18"
];

function initAlarms(station) {
  const cont = document.getElementById(`alarms-${station}`);
  cont.innerHTML = '';

  for (let i = 0; i < 16; i++) {
    const d = document.createElement('div');
    d.className = 'alarm inactive';
    d.id = `alarm-${station}-${i}`;
    d.textContent = alarmNames[i] + ' ‚úÖ';
    cont.appendChild(d);
  }
}


let alarmHistoryOTY = [];
let alarmHistoryITR = [];
let visibleHistoryOTY = [];
let visibleHistoryITR = [];
let lastStateOTY = 0;
let lastStateITR = 0;

/* ===== PARTE 5.3 ===== */
let historyLoaded = false;

window.onload = async () => {


initAlarms('OTY');
  initAlarms('ITR');

  alarmHistoryOTY = JSON.parse(localStorage.getItem('alarmHistoryOTY_2026')) || [];
  alarmHistoryITR = JSON.parse(localStorage.getItem('alarmHistoryITR_2026')) || [];

  visibleHistoryOTY = [...alarmHistoryOTY];
  visibleHistoryITR = [...alarmHistoryITR];

  renderHistory('OTY', visibleHistoryOTY);
  renderHistory('ITR', visibleHistoryITR);

  await loadHistoryFromBackend('OTY');
  await loadHistoryFromBackend('ITR');
  historyLoaded = true;
};

function updateStation(station, value) {
  let lastStateRef = station === 'OTY' ? lastStateOTY : lastStateITR;

  const cont = document.getElementById(`alarms-${station}`);
  let active = false;

  for (let i = 15; i >= 0; i--) {
  const bit = (value >> i) & 1;
  const prev = (lastStateRef >> i) & 1;


  const idx = 15 - i;
  const d = document.getElementById(`alarm-${station}-${idx}`);

  if (!d) continue;

  d.className = 'alarm ' + (bit ? 'active' : 'inactive');
  d.textContent = alarmNames[idx] + (bit ? ' üî•' : ' ‚úÖ');

  if (bit) active = true;
}

if (station === 'OTY') lastStateOTY = value;
  else lastStateITR = value;

}

function updateSvgOTY(value) {

  // Bit 11 ‚Üí Temperatura
  if ((value >> 11) & 1) {
    activarSvg("oty-temp");
  } else {
    desactivarSvg("oty-temp");
  }

  // Bit 10 ‚Üí Tierra
  if ((value >> 10) & 1) {
    activarSvg("oty-tierra");
  } else {
    desactivarSvg("oty-tierra");
  }

  // Bit 7 ‚Üí BAT EN OPER
  if ((value >> 7) & 1) {
    activarSvg("oty-battery");
  } else {
    desactivarSvg("oty-battery");
  }

  // Bit 8 ‚Üí Persona / Presencia
  if ((value >> 8) & 1) {
    activarSvg("oty-person");
  } else {
    desactivarSvg("oty-person");
  }

      // Bit 6 ‚Üí RECTIFICADOR CD (LIBRE 2)
  if ((value >> 6) & 1) {
    activarSvg("oty-rectifier");
  } else {
    desactivarSvg("oty-rectifier");
  }

  // Bit 5 ‚Üí BREAKERS (LIBRE 3)
  if ((value >> 5) & 1) {
    activarSvg("oty-breakers");
  } else {
    desactivarSvg("oty-breakers");
  }
}



async function loadHistoryFromBackend(station) {
  const res = await fetch(`${BACKEND_URL}/api/history/${station}`);
  const rows = await res.json();

  const parsed = rows.map(r => {
    const d = new Date(r.timestamp);
    return {
      date: d.toLocaleDateString('es-MX'),
      time: d.toLocaleTimeString('es-MX'),
      station: r.station,
      alarm: `${r.alarm_name} ${r.state}`
    };
  });

  if (station === 'OTY') {
    alarmHistoryOTY = parsed;
    visibleHistoryOTY = [...parsed];
  } else {
    alarmHistoryITR = parsed;
    visibleHistoryITR = [...parsed];
  }
  renderHistory(station, parsed);
}

function renderHistory(st, data) {
  const tb = document.getElementById(`alarm-history-${st}`);
  tb.innerHTML = '';
  data.forEach(e => {
    tb.innerHTML += `<tr><td>${e.date}</td><td>${e.time}</td><td>${e.station}</td><td>${e.alarm}</td></tr>`;
  });
}

function showAllHistory(st) {
  if (st === 'OTY') {
    visibleHistoryOTY = [...alarmHistoryOTY];
    renderHistory(st, visibleHistoryOTY);
  } else {
    visibleHistoryITR = [...alarmHistoryITR];
    renderHistory(st, visibleHistoryITR);
  }
}


function filterHistory(st, d) {
  const src = st === 'OTY' ? alarmHistoryOTY : alarmHistoryITR;

  const filtered = src.filter(e =>
    new Date(e.date.split('/').reverse().join('-'))
      .toISOString().slice(0, 10) === d
  );

  if (st === 'OTY') {
    visibleHistoryOTY = filtered;
  } else {
    visibleHistoryITR = filtered;
  }

  renderHistory(st, filtered);
}


async function clearHistory(st) {
  if (!confirm(`¬øBorrar historial de ${st}?`)) return;
  await fetch(`${BACKEND_URL}/api/history/${st}`, { method: 'DELETE' });
  if (st === 'OTY') alarmHistoryOTY = [];
  else alarmHistoryITR = [];
  renderHistory(st, []);
}

function downloadCSV(st) {
  // ‚¨áÔ∏è Descargar SOLO lo que est√° visible
  const src = st === 'OTY' ? visibleHistoryOTY : visibleHistoryITR;

  let csv = 'Fecha,Hora,Estaci√≥n,Alarma\n';
  src.forEach(e => {
    csv += `"${e.date}","${e.time}","${e.station}","${e.alarm}"\n`;
  });

  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
  a.download = `historial_${st}_2026.csv`;
  a.click();
}


function toggleAlarmTab(i, a) {
  document.querySelectorAll('.tab')[i].classList.toggle('alarm-active-tab', a);
}

function showTab(i) {
  document.querySelectorAll('.tab').forEach((t, x) => t.classList.toggle('active', x === i));
  document.querySelectorAll('.tab-content').forEach((c, x) => c.classList.toggle('active', x === i));
}

/* ===== SSE ===== */
const evtSource = new EventSource(`${BACKEND_URL}/api/events`);


evtSource.onmessage = e => {
  const data = JSON.parse(e.data);
 console.log('üì° SSE recibido:', data);
  // 1Ô∏è‚É£ Estado en tiempo real (rect√°ngulos + SVG)
  if (data.type === 'state') {
    updateStation('OTY', data.value);
    updateStation('ITR', data.value);
    updateSvgOTY(data.value);
      }

  // 2Ô∏è‚É£ Evento de historial en vivo
  if (data.type === 'history') {
    const d = new Date(data.timestamp);
    const entry = {
      date: d.toLocaleDateString('es-MX'),
      time: d.toLocaleTimeString('es-MX'),
      station: data.station,
      alarm: `${data.alarm} ${data.state}`
    };

    if (data.station === 'OTY') {
      alarmHistoryOTY.unshift(entry);
      renderHistory('OTY', alarmHistoryOTY);
    } else {
      alarmHistoryITR.unshift(entry);
      renderHistory('ITR', alarmHistoryITR);
    }
  }
};

</script>

<!-- ===== FUNCIONES SVG ===== -->
<script>
function activarSvg(id) {
  const el = document.getElementById(id);
  if (!el) return;
  el.classList.add("alarm-on");
}

function desactivarSvg(id) {
  const el = document.getElementById(id);
  if (!el) return;
  el.classList.remove("alarm-on");
}

</script>



</body>
</html>

